#!/usr/bin/env bash
set -euo pipefail
ETC_DIR="/etc/v2raytge"
CFG="$ETC_DIR/config.env"
. "$ETC_DIR/tge-lib.sh"
need_root
[[ -f "$CFG" ]] || { echo "Missing $CFG"; exit 1; }
# shellcheck disable=SC1090
. "$CFG"

GRE_IF="${GRE_IF:-gre-egress}"

log(){ echo "[tge-gre] $*"; }

if ip link show "$GRE_IF" >/dev/null 2>&1; then
  # validate tunnel params best-effort
  if ! ip -d tunnel show "$GRE_IF" 2>/dev/null | grep -q "remote $GRE_REMOTE_IP local $GRE_LOCAL_IP"; then
    log "WARN: $GRE_IF exists but differs; not modifying."
    exit 0
  fi
  # ensure address
  if ! ip -br addr show dev "$GRE_IF" | grep -qE "\\b${GRE_TUN_IP%/*}/"; then
    ip addr add "$GRE_TUN_IP" dev "$GRE_IF" || true
  fi
  ip link set "$GRE_IF" up || true
  ip link set dev "$GRE_IF" mtu "$GRE_MTU" || true
  log "OK: $GRE_IF present."
  exit 0
fi

ip tunnel add "$GRE_IF" mode gre local "$GRE_LOCAL_IP" remote "$GRE_REMOTE_IP" ttl 255
ip addr add "$GRE_TUN_IP" dev "$GRE_IF"
ip link set "$GRE_IF" up
ip link set dev "$GRE_IF" mtu "$GRE_MTU"
log "OK: $GRE_IF created."