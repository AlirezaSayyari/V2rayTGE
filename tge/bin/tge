#!/usr/bin/env bash
set -euo pipefail

ETC_DIR="/opt/v2raytge"
CFG="$ETC_DIR/config.env"
LOG_DIR="/var/log/v2raytge"

mkdir -p "$ETC_DIR" "$LOG_DIR"

menu() {
  clear
  echo "========================================"
  echo " V2rayTGE - Traffic Gateway Egress (CLI)"
  echo "========================================"
  echo "1) Help & Introduction"
  echo "2) Config Egress System (Wizard)"
  echo "3) Activate Egress System"
  echo "4) Deactivate Egress System"
  echo "5) Health Check"
  echo "6) Log"
  echo "0) Exit"
  echo "----------------------------------------"
  echo -n "Select: "
}

help_intro() {
  clear
  cat <<'EOF'
What is V2rayTGE?
- A production-safe egress gateway that forwards LAN traffic to the Internet through v2rayA (tun0).
- Traffic path: LAN -> Edge Device (Forti/Router/...) -> GRE -> EgressGW -> policy routing (table v2ray) -> tun0 -> Internet

Key behavior
- No iptables/ip rule flush
- No host default-route change
- Idempotent (safe to run repeatedly)
- Self-heal via systemd after reboot, docker restart, or network restart

Install flow (current)
- deploy.sh ensures Docker and Docker Compose are available.
- It deploys and starts v2rayA from /opt/v2raytge/docker/docker-compose.yml.
- Then it completes TGE CLI installation.

Prerequisites
- Ubuntu Server
- GRE tunnel from edge device to this server
- Edge device PBR/static routes that send LAN CIDRs over GRE

v2rayA GUI
- Default GUI: http://<EgressGW-IP>:2017
- In v2rayA, configure an outbound (VLESS/VMess/...) and enable TUN mode so tun0 is ready.

MTU/MSS note (important)
- If ping works but HTTPS/TLS stalls, you likely have PMTU blackhole.
- Apply MSS clamp on GRE -> tun0 path (for example, 1436 when GRE MTU is 1476).

EOF
  echo
  echo "Press Enter to return..."
  read -r
}

require_root() {
  if [[ "${EUID:-$(id -u)}" -ne 0 ]]; then
    echo "Run as root: sudo tge"
    exit 1
  fi
}

activate() {
  require_root
  /usr/local/sbin/tge-ctl --activate
  echo "Press Enter..."
  read -r
}

deactivate() {
  require_root
  /usr/local/sbin/tge-ctl --deactivate
  echo "Press Enter..."
  read -r
}

config_wizard() {
  require_root
  /usr/local/sbin/tge-config
  echo "Press Enter..."
  read -r
}

health() {
  require_root
  /usr/local/sbin/tge-health
  echo "Press Enter..."
  read -r
}

logs() {
  require_root
  /usr/local/sbin/tge-logs
  echo "Press Enter..."
  read -r
}

while true; do
  menu
  read -r choice
  case "$choice" in
    1) help_intro ;;
    2) config_wizard ;;
    3) activate ;;
    4) deactivate ;;
    5) health ;;
    6) logs ;;
    0) exit 0 ;;
    *) echo "Invalid. Enter..." ; read -r ;;
  esac
done
